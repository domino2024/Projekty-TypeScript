// milionerzy.ts
import * as readline from "node:readline/promises";
import { stdin as input, stdout as output } from "node:process";

const WYPLATY = [
    500,
    1000, // pr√≥g 1
    2000,
    5000,
    10000,
    20000,
    40000, // pr√≥g 2
    75000,
    125000,
    250000,
    500000,
    1000000,
] as const;

const PROG1 = 1000;
const PROG2 = 40000;

const LITERY = ["A", "B", "C", "D"] as const;
export type Litera = (typeof LITERY)[number];

export interface Pytanie {
    pytanie: string;
    odpowiedzi: [string, string, string, string];
    poprawna: Litera;
    poziom: number; // 1..12
}

const PYTANIA: Pytanie[] = [
    // Poziom 1 (≈Çatwe)
    {
        pytanie: "Jak nazywa siƒô stolica Polski?",
        odpowiedzi: ["Warszawa", "Krak√≥w", "Gda≈Ñsk", "Wroc≈Çaw"],
        poprawna: "A",
        poziom: 1,
    },
    {
        pytanie: "Ile dni ma tydzie≈Ñ?",
        odpowiedzi: ["5", "6", "7", "8"],
        poprawna: "C",
        poziom: 1,
    },
    {
        pytanie: "Jakiego koloru jest trawa latem?",
        odpowiedzi: ["Niebieska", "Zielona", "Czerwona", "Fioletowa"],
        poprawna: "B",
        poziom: 1,
    },
    // Poziom 2
    {
        pytanie: "Kt√≥ry z tych napoj√≥w zawiera kofeinƒô?",
        odpowiedzi: ["Woda", "Herbata", "Sok jab≈Çkowy", "Kompot"],
        poprawna: "B",
        poziom: 2,
    },
    {
        pytanie: "Ile to 2 + 2?",
        odpowiedzi: ["3", "4", "5", "6"],
        poprawna: "B",
        poziom: 2,
    },
    {
        pytanie: "Jak ma na imiƒô Kopciuszek w ba≈õni?",
        odpowiedzi: ["Cinderella", "Bella", "Ariel", "Jasmine"],
        poprawna: "A",
        poziom: 2,
    },
    // Poziom 3
    {
        pytanie: "Kt√≥ry pierwiastek chemiczny ma symbol O?",
        odpowiedzi: ["Z≈Çoto", "Tlen", "Srebro", "Cyna"],
        poprawna: "B",
        poziom: 3,
    },
    {
        pytanie: "Jak nazywa siƒô najwiƒôkszy ocean na Ziemi?",
        odpowiedzi: ["Atlantycki", "Indyjski", "Spokojny (Pacyfik)", "Arktyczny"],
        poprawna: "C",
        poziom: 3,
    },
    {
        pytanie: "W kt√≥rym kraju le≈ºy Piza ze s≈ÇynnƒÖ wie≈ºƒÖ?",
        odpowiedzi: ["Hiszpania", "W≈Çochy", "Francja", "Portugalia"],
        poprawna: "B",
        poziom: 3,
    },
    // Poziom 4
    {
        pytanie: "Ile wynosi liczba œÄ z dok≈Çadno≈õciƒÖ do dw√≥ch miejsc po przecinku?",
        odpowiedzi: ["3,12", "3,14", "3,16", "3,18"],
        poprawna: "B",
        poziom: 4,
    },
    {
        pytanie: "Kt√≥ry kontynent jest najmniejszy powierzchniowo?",
        odpowiedzi: ["Australia", "Europa", "Antarktyda", "Ameryka Po≈Çudniowa"],
        poprawna: "A",
        poziom: 4,
    },
    {
        pytanie: "Kto jest autorem 'Pana Tadeusza'?",
        odpowiedzi: ["Juliusz S≈Çowacki", "Boles≈Çaw Prus", "Adam Mickiewicz", "Henryk Sienkiewicz"],
        poprawna: "C",
        poziom: 4,
    },
    // Poziom 5
    {
        pytanie: "Ile godzin ma doba?",
        odpowiedzi: ["12", "24", "36", "48"],
        poprawna: "B",
        poziom: 5,
    },
    {
        pytanie: "Jak nazywa siƒô najwy≈ºszy szczyt ≈õwiata?",
        odpowiedzi: ["K2", "Mount Everest", "Kilimand≈ºaro", "Mont Blanc"],
        poprawna: "B",
        poziom: 5,
    },
    {
        pytanie: "W jakim mie≈õcie gra klub pi≈Çkarski FC Barcelona?",
        odpowiedzi: ["Madryt", "Valencia", "Barcelona", "Sewilla"],
        poprawna: "C",
        poziom: 5,
    },
    // Poziom 6
    {
        pytanie: "Kt√≥ry instrument ma klapy i stroik?",
        odpowiedzi: ["Klarnet", "Fortepian", "Skrzypce", "Bƒôben"],
        poprawna: "A",
        poziom: 6,
    },
    {
        pytanie: "Kt√≥ry gaz dominuje w atmosferze Ziemi?",
        odpowiedzi: ["Tlen", "Dwutlenek wƒôgla", "Azot", "Argon"],
        poprawna: "C",
        poziom: 6,
    },
    {
        pytanie: "W jakim jƒôzyku napisano 'Don Kichota'?",
        odpowiedzi: ["Po w≈Çosku", "Po hiszpa≈Ñsku", "Po francusku", "Po portugalsku"],
        poprawna: "B",
        poziom: 6,
    },
    // Poziom 7
    {
        pytanie: "Kt√≥re miasto le≈ºy nad We≈ÇtawƒÖ?",
        odpowiedzi: ["Praga", "Wiede≈Ñ", "Budapeszt", "Bratys≈Çawa"],
        poprawna: "A",
        poziom: 7,
    },
    {
        pytanie: "Kt√≥ry z wymienionych to pierwiastek szlachetny?",
        odpowiedzi: ["Krypton", "Wap≈Ñ", "≈ªelazo", "Mied≈∫"],
        poprawna: "A",
        poziom: 7,
    },
    {
        pytanie: "Kto namalowa≈Ç 'Gwia≈∫dzistƒÖ noc'?",
        odpowiedzi: ["Claude Monet", "Vincent van Gogh", "Pablo Picasso", "Edvard Munch"],
        poprawna: "B",
        poziom: 7,
    },
    // Poziom 8
    {
        pytanie: "Jak nazywa siƒô proces przej≈õcia cieczy w gaz?",
        odpowiedzi: ["Sublimacja", "Parowanie", "Skraplanie", "Resublimacja"],
        poprawna: "B",
        poziom: 8,
    },
    {
        pytanie: "Kt√≥ry pisarz stworzy≈Ç Sherlocka Holmesa?",
        odpowiedzi: ["Agatha Christie", "Arthur Conan Doyle", "Edgar Allan Poe", "J.K. Rowling"],
        poprawna: "B",
        poziom: 8,
    },
    {
        pytanie: "Kt√≥re pa≈Ñstwo nie graniczy z PolskƒÖ?",
        odpowiedzi: ["Litwa", "Bia≈Çoru≈õ", "S≈Çowacja", "Wƒôgry"],
        poprawna: "D",
        poziom: 8,
    },
    // Poziom 9
    {
        pytanie: "W kt√≥rym roku upad≈Ç Mur Berli≈Ñski?",
        odpowiedzi: ["1987", "1989", "1991", "1993"],
        poprawna: "B",
        poziom: 9,
    },
    {
        pytanie: "Kt√≥ry organ wytwarza insulinƒô?",
        odpowiedzi: ["WƒÖtroba", "Trzustka", "≈öledziona", "Tarczyca"],
        poprawna: "B",
        poziom: 9,
    },
    {
        pytanie: "Kt√≥ra planeta jest najbli≈ºej S≈Ço≈Ñca?",
        odpowiedzi: ["Wenus", "Ziemia", "Merkury", "Mars"],
        poprawna: "C",
        poziom: 9,
    },
    // Poziom 10
    {
        pytanie: "Jak nazywa siƒô stolica Kanady?",
        odpowiedzi: ["Toronto", "Montreal", "Ottawa", "Vancouver"],
        poprawna: "C",
        poziom: 10,
    },
    {
        pytanie: "Kt√≥ry jƒôzyk ma najwiƒôcej native speaker√≥w?",
        odpowiedzi: ["Angielski", "Hiszpa≈Ñski", "Mandary≈Ñski", "Hindustani"],
        poprawna: "C",
        poziom: 10,
    },
    {
        pytanie: "Kt√≥ry kompozytor by≈Ç g≈Çuchy pod koniec ≈ºycia?",
        odpowiedzi: ["Mozart", "Beethoven", "Bach", "Chopin"],
        poprawna: "B",
        poziom: 10,
    },
    // Poziom 11
    {
        pytanie: "Jak nazywa siƒô najwiƒôkszy ksiƒô≈ºyc Saturna?",
        odpowiedzi: ["Europa", "Ganimedes", "Tytan", "Kallisto"],
        poprawna: "C",
        poziom: 11,
    },
    {
        pytanie: "Twierdzenie Pitagorasa dotyczy jakich tr√≥jkƒÖt√≥w?",
        odpowiedzi: ["R√≥wnobocznych", "R√≥wnoramiennych", "ProstokƒÖtnych", "Dowolnych"],
        poprawna: "C",
        poziom: 11,
    },
    {
        pytanie: "Kt√≥ry z tych jƒôzyk√≥w NIE jest jƒôzykiem urzƒôdowym Szwajcarii?",
        odpowiedzi: ["Romansz", "W≈Çoski", "Francuski", "Hiszpa≈Ñski"],
        poprawna: "D",
        poziom: 11,
    },
    // Poziom 12 (trudne)
    {
        pytanie: "Kt√≥ry noblista napisa≈Ç 'Historiƒô i ≈õwiadomo≈õƒá klasowƒÖ'?",
        odpowiedzi: ["Karl Popper", "Gy√∂rgy Luk√°cs", "Friedrich Hayek", "Bertrand Russell"],
        poprawna: "B",
        poziom: 12,
    },
    {
        pytanie: "Kt√≥ry polski kr√≥l jako pierwszy koronowa≈Ç siƒô na Wawelu?",
        odpowiedzi: ["W≈Çadys≈Çaw ≈Åokietek", "Kazimierz Wielki", "Boles≈Çaw Chrobry", "Zygmunt Stary"],
        poprawna: "A",
        poziom: 12,
    },
    {
        pytanie: "W fizyce: sta≈Ça Plancka ma wymiar...",
        odpowiedzi: ["E¬∑t", "p¬∑l", "m¬∑a", "q¬∑V"],
        poprawna: "A",
        poziom: 12,
    },
];



function shuffle<T>(arr: T[]): T[] {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function pln(n: number): string {
    return new Intl.NumberFormat("pl-PL").format(n) + " z≈Ç";
}

function wrap(text: string, width = 60): string {
    const words = text.split(/\s+/);
    const lines: string[] = [];
    let line = "";
    for (const w of words) {
        if ((line + " " + w).trim().length > width) {
            lines.push(line.trim());
            line = w;
        } else {
            line += " " + w;
        }
    }
    if (line.trim()) lines.push(line.trim());
    return lines.join("\n");
}

class KolaRatunkowe {
    uzyte = { "5050": false, publicznosc: false, telefon: false, zmiana: false };
    dostepne(): (keyof KolaRatunkowe["uzyte"])[] {
        return Object.entries(this.uzyte)
            .filter(([, v]) => !v)
            .map(([k]) => k as keyof KolaRatunkowe["uzyte"]);
    }
}

function opiszKola(kola: KolaRatunkowe): string {
    const nazwy: Record<keyof KolaRatunkowe["uzyte"], string> = {
        "5050": "50:50",
        publicznosc: "Pytanie do publiczno≈õci",
        telefon: "Telefon do przyjaciela",
        zmiana: "Zmiana pytania",
    };
    return (Object.keys(kola.uzyte) as (keyof KolaRatunkowe["uzyte"])[])
        .map((klucz) => `- ${nazwy[klucz]} ${kola.uzyte[klucz] ? "(u≈ºyte)" : ""}`.trim())
        .join("\n");
}

function formatPytanie(q: Pytanie, dostepneLitery: Litera[] = [...LITERY]): string {
    const lines: string[] = [];
    lines.push("\n" + "=".repeat(60));
    lines.push(wrap(q.pytanie));
    lines.push("-");
    q.odpowiedzi.forEach((odp, i) => {
        const lit = LITERY[i];
        lines.push(` ${lit}) ${dostepneLitery.includes(lit) ? odp : "‚Äî‚Äî"}`);
    });
    return lines.join("\n");
}

function grupujIPobierzWybor(): Pytanie[] {
    const byLevel = new Map<number, Pytanie[]>();
    for (const p of PYTANIA) {
        const arr = byLevel.get(p.poziom) ?? [];
        arr.push(p);
        byLevel.set(p.poziom, arr);
    }
    const wybrane: Pytanie[] = [];
    for (let poziom = 1; poziom <= 12; poziom++) {
        const kandydaci = byLevel.get(poziom) ?? [];
        if (kandydaci.length < 1) {
            console.error(`Brak pyta≈Ñ dla poziomu ${poziom}!`);
            process.exit(1);
        }
        shuffle(kandydaci);
        wybrane.push(...kandydaci.slice(0, Math.min(2, kandydaci.length)));
    }
    shuffle(wybrane);
    return wybrane.sort((a, b) => a.poziom - b.poziom);
}

function zastosuj5050(q: Pytanie): Litera[] {
    const pozostale = LITERY.filter((l) => l !== q.poprawna);
    const losowa = pozostale[Math.floor(Math.random() * pozostale.length)];
    return [q.poprawna, losowa].sort() as Litera[];
}

function publicznoscSugestia(q: Pytanie): Record<Litera, number> {
    const poziom = q.poziom;
    const base = Math.max(55 - poziom * 2, 35);
    const pozostaleSum = 100 - base;
    const idxPop = LITERY.indexOf(q.poprawna);
    const resIdx = [0, 1, 2, 3].filter((i) => i !== idxPop);
    const a = randInt(10, Math.min(50, pozostaleSum));
    const b = randInt(0, pozostaleSum - a);
    const c = pozostaleSum - a - b;
    shuffle(resIdx);
    const arr = [0, 0, 0, 0];
    arr[idxPop] = base;
    [a, b, c].forEach((v, k) => (arr[resIdx[k]] = v));
    return { A: arr[0], B: arr[1], C: arr[2], D: arr[3] };
}

function telefonSugestia(q: Pytanie): Litera {
    if (Math.random() < 0.7) return q.poprawna;
    const bledne = LITERY.filter((l) => l !== q.poprawna);
    return bledne[Math.floor(Math.random() * bledne.length)];
}

function randInt(min: number, max: number): number {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

async function promptLine(rl: readline.Interface, q: string): Promise<string> {
    return (await rl.question(q)).trim();
}



export async function gra(): Promise<void> {
    const rl = readline.createInterface({ input, output });
    try {
        console.log("\nWitaj w grze MILIONERZY!\n");
        const imie = (await promptLine(rl, "Podaj swoje imiƒô: ")) || "Gracz";

        const pytania = grupujIPobierzWybor();
        const kola = new KolaRatunkowe();

        let wygrana = 0;
        let globalIdx = 0;
        let poziomDocelowy = 1;

        while (poziomDocelowy <= 12) {
            const idx = pytania.findIndex(
                (p, i) => p.poziom === poziomDocelowy && i >= globalIdx
            );
            if (idx === -1) break;

            let q = pytania[idx];
            let dostepneLitery: Litera[] = [...LITERY];

            while (true) {
                console.log(formatPytanie(q, dostepneLitery));
                console.log("\nWpisz A/B/C/D, 'K' aby u≈ºyƒá ko≈Ça ratunkowego, 'R' aby zrezygnowaƒá.");
                console.log("Ko≈Ça ratunkowe:\n" + opiszKola(kola));

                const wybor = (await promptLine(rl, ">> ")).toUpperCase() as Litera | "K" | "R";

                if (wybor === "R") {
                    console.log(`\n${imie}, rezygnujesz i zabierasz ${pln(wygrana)}!`);
                    return;
                }

                if (wybor === "K") {
                    const dostƒôpne = kola.dostepne();
                    if (dostƒôpne.length === 0) {
                        console.log("Brak dostƒôpnych k√≥≈Ç!");
                        continue;
                    }
                    console.log("\nWybierz ko≈Ço: 1) 50:50 2) Publiczno≈õƒá 3) Telefon 4) Zmiana pytania");
                    const k = await promptLine(rl, "Numer ko≈Ça: ");

                    if (k === "1" && !kola.uzyte["5050"]) {
                        dostepneLitery = zastosuj5050(q);
                        kola.uzyte["5050"] = true;
                        console.log("\n‚úÖ Zastosowano 50:50");
                        continue;
                    }
                    if (k === "2" && !kola.uzyte.publicznosc) {
                        kola.uzyte.publicznosc = true;
                        const rozklad = publicznoscSugestia(q);
                        console.log("\nüìä Wyniki publiczno≈õci:");
                        for (const lit of LITERY) console.log(` ${lit}: ${rozklad[lit]}%`);
                        continue;
                    }
                    if (k === "3" && !kola.uzyte.telefon) {
                        kola.uzyte.telefon = true;
                        const sug = telefonSugestia(q);
                        console.log(`\nüìû Przyjaciel: "My≈õlƒô, ≈ºe to ${sug}."`);
                        continue;
                    }
                    if (k === "4" && !kola.uzyte.zmiana) {
                        const zamiana = pytania.find((p, i) => p.poziom === q.poziom && i !== idx);
                        if (!zamiana) {
                            console.log("Brak rezerwowego pytania!");
                            continue;
                        }
                        pytania[idx] = zamiana;
                        q = zamiana;
                        kola.uzyte.zmiana = true;
                        dostepneLitery = [...LITERY];
                        console.log("\nüîÑ Zmieniono pytanie!");
                        continue;
                    }
                    console.log("Nieprawid≈Çowy wyb√≥r lub ko≈Ço ju≈º u≈ºyte!");
                    continue;
                }

                if (!LITERY.includes(wybor)) {
                    console.log("‚õî Podaj A/B/C/D, K lub R");
                    continue;
                }

                if (!dostepneLitery.includes(wybor)) {
                    console.log("‚õî Ta odpowied≈∫ zosta≈Ça usuniƒôta przez 50:50");
                    continue;
                }

                if (wybor === q.poprawna) {
                    wygrana = WYPLATY[poziomDocelowy - 1];
                    console.log(`\n‚úÖ Poprawna odpowied≈∫! Wygrywasz ${pln(wygrana)}.`);

                    if (wygrana === PROG1) console.log("(üè¶ OsiƒÖgniƒôto pr√≥g gwarantowany: 1 000 z≈Ç)");
                    if (wygrana === PROG2) console.log("(üè¶ OsiƒÖgniƒôto pr√≥g gwarantowany: 40 000 z≈Ç)");

                    poziomDocelowy++;
                    globalIdx = idx + 1;
                    break;
                } else {
                    const gwarant = wygrana >= PROG2 ? PROG2 : wygrana >= PROG1 ? PROG1 : 0;
                    console.log(`\n‚ùå B≈Çƒôdna odpowied≈∫. Zatrzymujesz ${pln(gwarant)}.`);
                    return;
                }
            }
        }

        console.log(`\nüéâ ${imie}, zosta≈Çe≈õ MILIONEREM! Wygrywasz ${pln(1000000)}!`);
    } finally {
        rl.close();
    }
}


gra();

